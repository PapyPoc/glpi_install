#!/usr/bin/env bash
#
# GLPI install script
# Author: PapyPoc
# Version: 1.7.0
# Main file
# Langage pris en compte français et anglais
#
set -euo pipefail
# Nettoyer le terminal
clear
# Charger les fichiers de configuration et de fonctions
    # Définir le répertoire du script
REP_SCRIPT="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$REP_SCRIPT/config" # Fichier de variable
source "$REP_SCRIPT/function" # Fichier de fonctions
load_language # Fichier de langue
ORIG_USER="${SUDO_USER:-$(logname 2>/dev/null || echo "${USER:-unknown}")}" # Détecte l'utilisateur réel
if [ "$EUID" -eq 0 ]; then # Vérifie si root
    info "$MSG_ROOT"
else
    if id -nG "${ORIG_USER}" 2>/dev/null | grep -Eqw "sudo|wheel"; then # Vérifie si l'utilisateur est déjà dans sudo ou wheel
        info "Relance du script via sudo pour l'utilisateur : ${ORIG_USER}"
        exec sudo -- "$0" "$@"
    else
        warn "L'utilisateur '${ORIG_USER}' n'appartient pas au groupe 'sudo' et le script n'est pas exécuté en root."
        exit 1
    fi
fi
if [ -f /etc/os-release ]; then # Détection de la distribution
    source /etc/os-release
    DISTRO_ID=${ID}
    info "Distribution détectée : $DISTRO_ID $VERSION_ID"
else
    warn "Impossible de détecter la distribution (pas de /etc/os-release)"
    exit 1
fi
case "${DISTRO_ID}" in # Choix du groupe admin
    debian|ubuntu)
        ADMIN_GROUP="sudo";;
    centos|rhel|rocky|almalinux|fedora)
        ADMIN_GROUP="wheel";;
    *)
        ADMIN_GROUP="sudo"
        info "Distribution $DISTRO_ID non reconnue, utilisation de '$ADMIN_GROUP' par défaut.";;
esac
# Vérification de l'appartenance
if id -nG "${ORIG_USER}" | grep -qw "${ADMIN_GROUP}"; then
    info "L'utilisateur ${ORIG_USER} est déjà dans le groupe ${ADMIN_GROUP}."
else
    info "Ajout de ${ORIG_USER} dans le groupe ${ADMIN_GROUP}..."
    usermod -aG "${ADMIN_GROUP}" "${ORIG_USER}"
    if [ $? -eq 0 ]; then
        info "${ORIG_USER} ajouté avec succès au groupe ${ADMIN_GROUP}."
        info "Veuillez vous déconnecter et vous reconnecter pour que les changements prennent effet."
    else
        warn "Échec lors de l'ajout de ${ORIG_USER} au groupe ${ADMIN_GROUP}."
        exit 1
    fi
fi
# Installation des outils de base après vérification de la distribution
if [[ "${DISTRO_ID}" =~ ^(debian|ubuntu)$ ]]; then
    if ! apt-get update &> /dev/null; then
        warn "Échec de la mise à jour des paquets"
        exit 1
    fi
    if ! apt-get install -y curl jq sudo &> /dev/null; then
        warn "Échec de l'installation des outils de base"
        exit 1
    fi
elif [[ "${DISTRO_ID}" =~ ^(centos|rhel|rocky|almalinux|fedora)$ ]]; then
    if ! dnf install -y curl jq wheel &> /dev/null && ! yum install -y curl jq wheel &> /dev/null; then
        warn "Échec de l'installation des outils de base"
        exit 1
    fi
fi
check_dialog # Regarde si dialog est installé
check_distro # Regarde si la distribution est conforme
check_install "${REP_GLPI}" # Regarde si GLPI est installé ou pas
display_result # Affiche le résultat de l'installation