#!/usr/bin/env bash
#
# GLPI install script
# Author: PapyPoc
# Version: 1.8.0
# Main file
# Langage pris en compte français et anglais
#
set -Eeuo pipefail
clear # Nettoyer le terminal
REP_SCRIPT="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)" # Définir le répertoire du script
# shellcheck disable=SC1091
. "${REP_SCRIPT}/function" # Fichier de fonctions
trap 'on_error' ERR
# shellcheck disable=SC1091
. "${REP_SCRIPT}/config" # Fichier de variable
load_language # Fichier de langue
# Regarde si la distribution est conforme
info "${MSG_START_SCRIPT}"
info "${MSG_CHECK_DISTRIBUTION}"
if ! check_distro; then # Vérifie la distribution
   dialog --title "${MSG_DIALOG_ERROR_TITLE}" --msgbox "${MSG_DISTRO_CHECK_FAILED}" 6 50
    error "${MSG_DISTRO_CHECK_ERROR}"
    exit 1
fi
info "${MSG_PROMPT_INSTALL_OPTIONS}"
if ! prompt_install_options; then # Demande les options d'installation
    dialog --title "${MSG_DIALOG_ERROR_TITLE}" --msgbox "${MSG_PROMPT_OPTIONS_FAILED}" 6 70
    error "${MSG_PROMPT_OPTIONS_ERROR}"
    exit 1
fi
info "${MSG_DISPLAY_RESULT}"
if ! display_result; then # Affiche le résultat de l'installation
    dialog --title "${MSG_DIALOG_ERROR_TITLE}" --msgbox "${MSG_DISPLAY_RESULT_FAILED}" 6 50
    error "${MSG_DISPLAY_RESULT_ERROR}"
    exit 1
fi
if [ -f "${FICHIER_MSG}" ]; then # Vérifie si le fichier de sauvegarde existe
    chmod 600 "${FICHIER_MSG}"
    chown root:root "${FICHIER_MSG}"
    dialog --title "${MSG_DIALOG_INFO_TITLE}" --msgbox "${MSG_BACKUP_CREATED}" 6 60
    echo "${MSG_BACKUP_CREATED}" 1>> "${DEBUGFILE}"
else
    dialog --title "${MSG_DIALOG_ERROR_TITLE}" --msgbox "${MSG_BACKUP_NOT_FOUND}" 6 60
    error "$MSG_ERROR_FICHIER_MSG" 1>> "${ERRORFILE}"
    exit 1
fi
if [ -s "${ERRORFILE}" ]; then
    dialog --title "${MSG_DIALOG_WARNING_TITLE}" --msgbox "${MSG_WARN_CHECK_LOG} ${ERRORFILE}" 8 70
else
    find "${INVOKING_HOME}" -maxdepth 1 -type d -name "${ERRORFILE}" -exec rm -rf {} +
fi
if [ -s "${DEBUGFILE}" ]; then
    dialog --title "${MSG_DIALOG_WARNING_TITLE}" --msgbox "${MSG_WARN_CHECK_LOG} ${DEBUGFILE}" 8 70
else
    find "${INVOKING_HOME}" -maxdepth 1 -type d -name "${DEBUGFILE}" -exec rm -rf {} +
fi
if [ -s "${UPDATEFILE}" ]; then
    dialog --title "${MSG_DIALOG_WARNING_TITLE}" --msgbox "${MSG_WARN_CHECK_LOG} ${UPDATEFILE}" 8 70
else
    find "${INVOKING_HOME}" -maxdepth 1 -type d -name "${UPDATEFILE}" -exec rm -rf {} +
fi
info "${MSG_END_SCRIPT}" >> "${DEBUGFILE}"
exit 0