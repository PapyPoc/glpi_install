#!/usr/bin/env bash
#
# GLPI install script
# Author: PapyPoc
# Version 1.8.0
# Variable file
#
set -euo pipefail
# Ne pas continuer si le script est exécuté directement
if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
    echo -e "Ce fichier doit être sourcé, pas exécuté.\n" >&2
    echo -e "This file must be sourced, not executed.\n" >&2
    exit 1
fi
# === Constantes globales exportables ===
# Ensure required commands are present by delegating to ensure_dependencies()
# Source function (where ensure_dependencies is defined) relative to this file
script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
if [ -f "${script_dir}/function" ]; then
    # shellcheck disable=SC1091
    source "${script_dir}"/function
fi
# Try to ensure dependencies (curl, jq, openssl) are available
if declare -F ensure_dependencies >/dev/null 2>&1; then
    ensure_dependencies || { echo "Failed to ensure dependencies" >&2; return 1; }
    if [ "${NEED_RESTART:-0}" -eq 1 ]; then
        # Restart top-level script that sourced this file
        idx=$(( ${#BASH_SOURCE[@]} - 1 ))
        top_script="${BASH_SOURCE[$idx]}"
        if [ -n "$top_script" ] && [ "$top_script" != "$(basename "$SHELL")" ]; then
            echo "Dependencies installed. Restarting $top_script..." >&2
            if [ -x "$top_script" ]; then
                exec "$top_script"
            else
                exec "$SHELL" -lc "bash '$(printf '%q' "$top_script")'"
            fi
        else
            echo "Dependencies installed. Please re-run your installer." >&2
            return 0
        fi
    fi
else
    echo "Warning: ensure_dependencies not available; skipping automatic install check." >&2
fi
export DOWNLOADLINK; DOWNLOADLINK=$(curl -s https://api.github.com/repos/glpi-project/glpi/releases/latest | jq -r '.assets[0].browser_download_url')
if [ -z "$DOWNLOADLINK" ] || [ "$DOWNLOADLINK" = "null" ]; then
    echo "Erreur: Impossible de récupérer le lien de téléchargement GLPI" >&2
    return 1
fi
export NEW_VERSION; NEW_VERSION=$(curl -s https://api.github.com/repos/glpi-project/glpi/releases/latest | jq -r '.name')
if [ -z "$NEW_VERSION" ] || [ "$NEW_VERSION" = "null" ]; then
    echo "Erreur: Impossible de récupérer la version GLPI" >&2
    return 1
fi
export DEBIAN_VERSIONS=("11" "12")
export UBUNTU_VERSIONS=("23.10" "24.10")
export ALMA_VERSIONS=("9.5")
export CENTOS_VERSIONS=("9")
export ROCKY_VERSIONS=("9.5")
export REDHAT_VERSIONS=("9.5")
export REP_BACKUP="/root/glpi_sauve/"
export REP_GLPI="/var/www/html/glpi/"
export SQLROOTPWD; SQLROOTPWD=$(openssl rand -base64 48 | cut -c1-18)
export SQLGLPIPWD; SQLGLPIPWD=$(openssl rand -base64 48 | cut -c1-18)
export ADMINGLPIPWD; ADMINGLPIPWD=$(openssl rand -base64 48 | cut -c1-12)
export POSTGLPIPWD; POSTGLPIPWD=$(openssl rand -base64 48 | cut -c1-12)
export TECHGLPIPWD; TECHGLPIPWD=$(openssl rand -base64 48 | cut -c1-12)
export NORMGLPIPWD; NORMGLPIPWD=$(openssl rand -base64 48 | cut -c1-12)
export DB_NAME="glpi"
export DB_USER="glpi_user"
export CURRENT_DATE_TIME; CURRENT_DATE_TIME=$(date +"%d-%m-%Y_%H-%M-%S")
export BDD_BACKUP="bdd_glpi-${CURRENT_DATE_TIME}.sql"
export FICHIER_MSG="${REP_SCRIPT}/sauve_mdp.txt"
export SUCCES_FILE="${REP_SCRIPT}/succes.log"
export ERROR_FILE="${REP_SCRIPT}/error.log"
export LOG_FILE="${REP_SCRIPT}/glpi_install.log"